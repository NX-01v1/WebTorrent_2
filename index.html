<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebTorrent ファイル共有</title>
    <!-- PWA用 manifest ファイルの読み込み -->
    <link rel="manifest" href="/manifest.json">
    <!-- Tailwind CSS を CDN 経由で読み込む -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- WebTorrent を CDN 経由で読み込む -->
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <!-- QR Code Generator ライブラリを CDN 経由で読み込む -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <!-- html5-qrcode ライブラリを CDN 経由で読み込む -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- Firebase SDK を CDN 経由で読み込む -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore への接続を初期化するための準備
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth;
        let linkMap = {}; // 6桁のコードとマグネットリンクの対応を保存するローカルオブジェクト

        // Firebaseの初期化と認証
        const setupFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 認証トークンがあればカスタム認証、なければ匿名認証
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                console.log("Firebase 認証成功");
                
                // onAuthStateChangedリスナーを使用して、認証状態が変化したときにFirestoreの処理を実行
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // 認証が完了したらFirestoreのデータを同期
                        const linksCollection = collection(db, `artifacts/${appId}/public/data/webtorrent_links`);
                        onSnapshot(linksCollection, (snapshot) => {
                            linkMap = {};
                            snapshot.forEach((doc) => {
                                const data = doc.data();
                                linkMap[data.shareCode] = data.magnetURI;
                            });
                            console.log("Firestore データ同期完了:", linkMap);
                        });
                    } else {
                        console.log("ユーザーがサインアウトしました");
                        // ユーザーがサインアウトした場合の処理（オプション）
                    }
                });

            } catch (error) {
                console.error("Firebase の初期化または認証中にエラーが発生しました:", error);
                showModal('エラー', 'Firebaseへの接続中にエラーが発生しました。ページをリロードしてください。');
            }
        };

        setupFirebase();
        
        // グローバルスコープに公開
        window.linkMap = linkMap;
        window.db = db;
        window.auth = auth;
        window.appId = appId;

        // カスタムモーダル表示用の関数
        function showModal(title, message) {
            const modal = document.getElementById('messageModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            modal.classList.remove('hidden');
        }

        // カスタムモーダルをグローバルに公開
        window.showModal = showModal;

    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container-box {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
        }
        .btn {
            @apply px-6 py-3 rounded-full font-semibold text-white transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-upload {
            @apply bg-blue-600 hover:bg-blue-700 focus:ring-blue-500;
        }
        .btn-download {
            @apply bg-green-600 hover:bg-green-700 focus:ring-green-500;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 横画面用のレイアウト設定 */
        @media (min-width: 768px) {
            .main-content {
                display: flex;
                gap: 2rem;
            }
            .container-box {
                max-width: 1000px; /* デスクトップ表示の最大幅 */
            }
        }

        /* モーダル用のスタイル */
        .modal {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 1.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        #reader {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="container-box w-full text-center">
        <h1 class="text-4xl font-bold text-gray-800 mb-6 hidden md:block">WebTorrent ファイル共有</h1>
        <div class="main-content">
            <!-- アップロードセクション -->
            <div class="mb-8 p-6 border border-gray-200 rounded-xl flex-1">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">ファイルを共有する</h2>
                <p class="text-sm text-gray-500 mb-4">共有したいファイルを選択してください。</p>
                <input type="file" id="fileInput" class="hidden" />
                <button id="uploadBtn" class="btn btn-upload w-full">
                    ファイルを選択
                </button>
                <div id="uploadStatus" class="mt-4 hidden">
                    <div class="loader mx-auto mb-2"></div>
                    <p class="text-sm text-gray-600">共有コードとQRコードを生成中です...</p>
                    <p id="uploadWakeLockStatus" class="text-xs text-gray-500 mt-2"></p>
                </div>
                <div id="uploadResult" class="mt-4 hidden p-4 bg-gray-100 rounded-lg">
                    <p class="text-sm text-gray-500 mb-2">この6桁のコードを共有してください:</p>
                    <p class="text-3xl font-bold text-gray-800" id="shareCode"></p>
                    <div id="qrcode" class="mt-4 flex justify-center"></div>
                </div>
            </div>

            <!-- ダウンロードセクション -->
            <div class="p-6 border border-gray-200 rounded-xl flex-1">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">ファイルをダウンロードする</h2>
                <p class="text-sm text-gray-500 mb-4">共有された6桁のコードを貼り付けてください。</p>
                <input type="text" id="magnetURI" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring focus:ring-blue-200 focus:border-blue-500" placeholder="6桁のコード" />
                <div class="flex space-x-2">
                    <button id="downloadBtn" class="btn btn-download flex-1">ダウンロード開始</button>
                    <button id="historyBtn" class="btn btn-upload flex-1">履歴を表示</button>
                </div>
                <div class="mt-2">
                    <button id="qrReaderBtn" class="btn btn-upload w-full text-sm">QRコードを読み取る</button>
                </div>
                <div id="downloadStatus" class="mt-4 hidden">
                    <p class="text-sm text-gray-600" id="downloadMessage"></p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%;"></div>
                    </div>
                    <p id="downloadWakeLockStatus" class="text-xs text-gray-500 mt-2"></p>
                </div>
                <div id="downloadResult" class="mt-4 hidden">
                    <p class="text-gray-700 font-medium mb-2">ダウンロード完了！</p>
                    <div id="downloadLinks" class="flex flex-col space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 履歴モーダル -->
    <div id="historyModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" id="closeHistoryModal">&times;</span>
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">共有履歴</h2>
            <ul id="historyList" class="max-h-80 overflow-y-auto">
                <!-- 履歴アイテムがここに追加されます -->
            </ul>
        </div>
    </div>
    
    <!-- QRコードリーダーモーダル -->
    <div id="qrReaderModal" class="modal hidden">
        <div class="modal-content text-center">
            <span class="close-btn" id="closeQrReaderModal">&times;</span>
            <h2 class="text-xl font-semibold text-gray-700 mb-4">QRコードをスキャン</h2>
            <div id="reader"></div>
        </div>
    </div>
    
    <!-- カスタムメッセージモーダル -->
    <div id="messageModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" id="closeMessageModal">&times;</span>
            <h2 id="modalTitle" class="text-xl font-semibold text-gray-700 mb-2"></h2>
            <p id="modalMessage" class="text-sm text-gray-600"></p>
        </div>
    </div>

    <script>
        // PWAのService Workerを登録
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then(registration => {
                    console.log('Service Worker 登録成功:', registration.scope);
                }).catch(err => {
                    console.log('Service Worker 登録失敗:', err);
                });
            });
        }
    </script>
    <script type="module">
        import { collection, addDoc, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM要素の取得
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadResult = document.getElementById('uploadResult');
        const shareCodeEl = document.getElementById('shareCode');
        const qrcodeContainer = document.getElementById('qrcode');
        const uploadWakeLockStatus = document.getElementById('uploadWakeLockStatus');

        const magnetURIInput = document.getElementById('magnetURI');
        const downloadBtn = document.getElementById('downloadBtn');
        const historyBtn = document.getElementById('historyBtn');
        const qrReaderBtn = document.getElementById('qrReaderBtn');
        const historyModal = document.getElementById('historyModal');
        const qrReaderModal = document.getElementById('qrReaderModal');
        const messageModal = document.getElementById('messageModal'); // 新しいメッセージモーダル
        const historyList = document.getElementById('historyList');
        const closeHistoryModalBtn = document.getElementById('closeHistoryModal');
        const closeQrReaderModalBtn = document.getElementById('closeQrReaderModal');
        const closeMessageModalBtn = document.getElementById('closeMessageModal'); // メッセージモーダルを閉じるボタン
        const downloadStatus = document.getElementById('downloadStatus');
        const downloadMessage = document.getElementById('downloadMessage');
        const progressBar = document.getElementById('progressBar');
        const downloadResult = document.getElementById('downloadResult');
        const downloadLinks = document.getElementById('downloadLinks');
        const downloadWakeLockStatus = document.getElementById('downloadWakeLockStatus');

        // WebTorrent クライアントの初期化
        const client = new WebTorrent();

        // Wake Lock 変数
        let wakeLock = null;

        // Wake Lock をリクエストする関数
        const requestWakeLock = async (statusEl) => {
            if ('WakeLock' in window && 'request' in navigator.wakeLock) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock が解放されました');
                    });
                    console.log('Wake Lock がアクティブになりました');
                    statusEl.textContent = 'スリープ防止機能が有効です。';
                } catch (err) {
                    console.error('Wake Lock のリクエストに失敗しました:', err);
                    statusEl.textContent = 'スリープ防止機能が無効です。';
                }
            } else {
                statusEl.textContent = 'お使いのブラウザはスリープ防止機能をサポートしていません。';
            }
        };

        // Wake Lock を解放する関数
        const releaseWakeLock = () => {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
                console.log('Wake Lock が解放されました');
            }
            uploadWakeLockStatus.textContent = '';
            downloadWakeLockStatus.textContent = '';
        };

        // タブが非表示になったら Wake Lock を解放
        document.addEventListener('visibilitychange', () => {
            if (wakeLock !== null && document.visibilityState === 'hidden') {
                releaseWakeLock();
            }
        });

        // QRコード生成関数
        function generateQRCode(text) {
            qrcodeContainer.innerHTML = '';
            const typeNumber = 0; // QRコードのバージョン（自動選択）
            const errorCorrectionLevel = 'L'; // 誤り訂正レベル
            const qr = qrcode(typeNumber, errorCorrectionLevel);
            qr.addData(text);
            qr.make();
            const imgTag = qr.createImgTag(5);
            const imgElement = document.createElement('div');
            imgElement.innerHTML = imgTag;
            qrcodeContainer.appendChild(imgElement.firstChild);
        }

        // 6桁のコードを生成
        function generateCode() {
            let newCode;
            do {
                newCode = Math.floor(100000 + Math.random() * 900000).toString();
            } while (window.linkMap.hasOwnProperty(newCode));
            return newCode;
        }

        // アップロードボタンのクリックイベント
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // ファイル入力の変更イベント（アップロード）
        fileInput.addEventListener('change', async (event) => {
            const files = event.target.files;
            if (files.length === 0) return;

            // UIを更新
            uploadStatus.classList.remove('hidden');
            uploadResult.classList.add('hidden');
            shareCodeEl.textContent = '';
            qrcodeContainer.innerHTML = '';

            // Wake Lock をリクエスト
            await requestWakeLock(uploadWakeLockStatus);

            try {
                // WebTorrent でファイルをシードする
                client.seed(files, async (torrent) => {
                    uploadStatus.classList.add('hidden');
                    uploadResult.classList.remove('hidden');

                    const magnetURI = torrent.magnetURI;
                    const shareCode = generateCode();
                    
                    shareCodeEl.textContent = shareCode;
                    generateQRCode(shareCode);

                    // Firestoreにデータを保存
                    if (window.db && window.auth.currentUser) {
                        try {
                            await addDoc(collection(window.db, `artifacts/${window.appId}/public/data/webtorrent_links`), {
                                shareCode: shareCode,
                                magnetURI: magnetURI,
                                createdAt: new Date().toISOString(),
                                fileName: files[0].name // ファイル名も保存
                            });
                            console.log("Firestoreにデータを保存しました");
                        } catch (e) {
                            console.error("Firestoreへのデータ追加中にエラーが発生しました:", e);
                            showModal('エラー', '共有コードの保存中にエラーが発生しました。');
                        }
                    } else {
                        console.error("Firestoreが初期化されていないか、認証されていません");
                        showModal('エラー', 'データベースに接続できません。ページをリロードしてください。');
                    }
                    
                    // 転送完了時に Wake Lock を解放
                    torrent.on('done', () => {
                        releaseWakeLock();
                    });

                    // 接続されたピア数を表示（オプション）
                    setInterval(() => {
                        console.log(`ピア数: ${torrent.numPeers}`);
                    }, 1000);
                });
            } catch (error) {
                console.error("ファイルのシード中にエラーが発生しました:", error);
                uploadStatus.classList.add('hidden');
                releaseWakeLock(); // エラー発生時も解放
                showModal('エラー', 'ファイルのアップロード中にエラーが発生しました。');
            }
        });

        // ダウンロードボタンのクリックイベント
        downloadBtn.addEventListener('click', async () => {
            const input = magnetURIInput.value.trim();
            let magnetURI = null;

            // 入力が6桁の数字かチェックし、ローカルのマップからマグネットリンクを取得
            if (/^\d{6}$/.test(input)) {
                magnetURI = window.linkMap[input];
                if (!magnetURI) {
                    // ローカルに見つからなければFirestoreから検索
                    console.log("Firestoreを検索中...");
                    downloadMessage.textContent = 'コードを検索しています...';
                    
                    if (window.db && window.auth.currentUser) {
                        const q = query(collection(window.db, `artifacts/${window.appId}/public/data/webtorrent_links`), where("shareCode", "==", input));
                        try {
                            const querySnapshot = await getDocs(q);
                            if (!querySnapshot.empty) {
                                const docData = querySnapshot.docs[0].data();
                                magnetURI = docData.magnetURI;
                                window.linkMap[input] = magnetURI; // ローカルにキャッシュ
                            }
                        } catch (e) {
                            console.error("Firestoreの検索中にエラーが発生しました:", e);
                        }
                    }
                }
            }
            
            if (!magnetURI) {
                showModal('エラー', '無効な6桁のコードです。');
                return;
            }

            // Wake Lock をリクエスト
            await requestWakeLock(downloadWakeLockStatus);

            // UIを初期化
            downloadStatus.classList.remove('hidden');
            downloadResult.classList.add('hidden');
            downloadLinks.innerHTML = '';
            downloadMessage.textContent = 'ダウンロードを開始しています...';
            progressBar.style.width = '0%';

            let lastDownloaded = 0;
            let lastTime = Date.now();
            let intervalId = null;

            try {
                // WebTorrent でファイルをダウンロード
                client.add(magnetURI, (torrent) => {
                    downloadMessage.textContent = 'ダウンロード中...';
                    
                    intervalId = setInterval(() => {
                        const downloaded = torrent.downloaded;
                        const currentTime = Date.now();
                        const timeElapsed = (currentTime - lastTime) / 1000; // 秒
                        
                        // ダウンロード速度が0だとETAがInfinityになるのでチェック
                        let currentSpeed = 0;
                        if (timeElapsed > 0) {
                            currentSpeed = (downloaded - lastDownloaded) / timeElapsed; // バイト/秒
                        }
                        
                        const remainingBytes = torrent.length - downloaded;
                        const remainingTime = remainingBytes / currentSpeed;

                        const progress = Math.round(torrent.progress * 100);
                        progressBar.style.width = `${torrent.progress * 100}%`;
                        
                        let etaText = '';
                        if (isFinite(remainingTime) && remainingTime > 0) {
                            // 残り時間を分と秒で表示
                            const minutes = Math.floor(remainingTime / 60);
                            const seconds = Math.floor(remainingTime % 60);
                            etaText = `残り ${minutes}分${seconds}秒`;
                        } else {
                            etaText = '...';
                        }

                        downloadMessage.textContent = `ダウンロード中... ${progress}% (${etaText})`;
                        
                        lastDownloaded = downloaded;
                        lastTime = currentTime;
                    }, 1000); // 1秒ごとに更新

                    // ダウンロード完了
                    torrent.on('done', () => {
                        clearInterval(intervalId); // インターバルを停止
                        downloadMessage.textContent = 'ダウンロード完了！';
                        progressBar.style.width = '100%';
                        downloadResult.classList.remove('hidden');
                        releaseWakeLock(); // 完了時に Wake Lock を解放
                        
                        // 各ファイルに対してダウンロードリンクを作成
                        torrent.files.forEach(file => {
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(file.blob);
                            link.download = file.name;
                            link.textContent = `ダウンロード: ${file.name}`;
                            link.classList.add('text-blue-600', 'hover:underline');
                            downloadLinks.appendChild(link);
                        });
                    });
                });
            } catch (error) {
                console.error("ダウンロード中にエラーが発生しました:", error);
                if (intervalId) clearInterval(intervalId);
                downloadStatus.classList.add('hidden');
                releaseWakeLock(); // エラー発生時も解放
                showModal('エラー', 'ファイルのダウンロード中にエラーが発生しました。');
            }
        });

        // 履歴ボタンのクリックイベント
        historyBtn.addEventListener('click', async () => {
            if (window.db && window.auth.currentUser) {
                historyList.innerHTML = '';
                const linksCollection = collection(window.db, `artifacts/${window.appId}/public/data/webtorrent_links`);
                
                try {
                    const querySnapshot = await getDocs(linksCollection);
                    if (querySnapshot.empty) {
                        historyList.innerHTML = `<li class="text-gray-500 text-center py-4">履歴はありません。</li>`;
                    } else {
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            const li = document.createElement('li');
                            li.classList.add('p-3', 'mb-2', 'bg-gray-100', 'rounded-lg', 'cursor-pointer', 'hover:bg-gray-200', 'transition-colors');
                            li.innerHTML = `
                                <span class="font-bold">${data.shareCode}</span>
                                <span class="text-sm text-gray-600 ml-2">${data.fileName || '不明なファイル'}</span>
                            `;
                            li.addEventListener('click', () => {
                                magnetURIInput.value = data.shareCode;
                                historyModal.classList.add('hidden');
                            });
                            historyList.appendChild(li);
                        });
                    }
                } catch (e) {
                    console.error("履歴の取得中にエラーが発生しました:", e);
                    historyList.innerHTML = `<li class="text-red-500 text-center py-4">履歴の読み込みに失敗しました。</li>`;
                }
            } else {
                historyList.innerHTML = `<li class="text-red-500 text-center py-4">データベースに接続できません。</li>`;
            }
            historyModal.classList.remove('hidden');
        });

        // モーダルを閉じる
        closeHistoryModalBtn.addEventListener('click', () => {
            historyModal.classList.add('hidden');
        });
        
        closeMessageModalBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        window.addEventListener('click', (event) => {
            if (event.target === historyModal) {
                historyModal.classList.add('hidden');
            }
            if (event.target === messageModal) {
                messageModal.classList.add('hidden');
            }
        });

        // QRコードリーダーの初期化と開始/停止
        const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
        
        qrReaderBtn.addEventListener('click', () => {
            qrReaderModal.classList.remove('hidden');
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        });

        closeQrReaderModalBtn.addEventListener('click', () => {
            qrReaderModal.classList.add('hidden');
            html5QrcodeScanner.clear();
        });

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Code matched = ${decodedText}`, decodedResult);
            magnetURIInput.value = decodedText;
            qrReaderModal.classList.add('hidden');
            html5QrcodeScanner.clear();
        }

        function onScanFailure(error) {
            // エラーを静かに処理（コンソールにログを出力）
            console.warn(`QRコードスキャン失敗: ${error}`);
        }
    </script>
</body>
</html>
